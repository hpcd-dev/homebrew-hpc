name: Build bottles

on:
  workflow_dispatch:

env:
  HOMEBREW_NO_AUTO_UPDATE: "1"
  HOMEBREW_NO_INSTALL_FROM_API: "1"  # ensure Homebrew uses tap formula, not API metadata

jobs:
  bottle:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-15, macos-26, ubuntu-22.04]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Homebrew (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "/opt/homebrew/bin" >> "$GITHUB_PATH"

      - name: Install Homebrew (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl file git
          NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin" >> "$GITHUB_PATH"
          echo "/home/linuxbrew/.linuxbrew/sbin" >> "$GITHUB_PATH"

      - name: Compute tap + formula name
        run: |
          repo="${GITHUB_REPOSITORY#*/}"
          tap_repo="${repo#homebrew-}"
          tap="${GITHUB_REPOSITORY_OWNER}/${tap_repo}"
          echo "TAP=${tap}" >> "$GITHUB_ENV"
          echo "FORMULA=${tap}/hpc" >> "$GITHUB_ENV"

      - name: Tap this repository
        run: |
          if brew tap | grep -Fxq "${TAP}"; then
            brew untap "${TAP}"
          fi
          brew tap "${TAP}" "${GITHUB_WORKSPACE}"

      - name: Compute version + root_url
        id: meta
        run: |
          version="$(brew info --json=v2 "${FORMULA}" | python3 -c 'import json, sys; data=json.load(sys.stdin); print(data["formulae"][0]["versions"]["stable"])')"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "root_url=https://github.com/${GITHUB_REPOSITORY}/releases/download/hpc-${version}" >> "$GITHUB_OUTPUT"

      - name: Build bottle
        run: |
          brew install --build-bottle "${FORMULA}"
          brew bottle --no-rebuild --json --root-url "${{ steps.meta.outputs.root_url }}" "${FORMULA}"
          mkdir -p dist
          mv *.bottle*.tar.gz dist/
          mv *.json dist/

      - uses: actions/upload-artifact@v4
        with:
          name: bottles-${{ matrix.os }}
          path: dist/*

  publish:
    runs-on: ubuntu-22.04
    needs: bottle
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Homebrew (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl file git
          NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin" >> "$GITHUB_PATH"
          echo "/home/linuxbrew/.linuxbrew/sbin" >> "$GITHUB_PATH"

      - name: Compute tap + formula name
        run: |
          repo="${GITHUB_REPOSITORY#*/}"
          tap_repo="${repo#homebrew-}"
          tap="${GITHUB_REPOSITORY_OWNER}/${tap_repo}"
          echo "TAP=${tap}" >> "$GITHUB_ENV"
          echo "FORMULA=${tap}/hpc" >> "$GITHUB_ENV"

      - name: Tap this repository
        run: |
          if brew tap | grep -Fxq "${TAP}"; then
            brew untap "${TAP}"
          fi
          brew tap "${TAP}" "${GITHUB_WORKSPACE}"

      - uses: actions/download-artifact@v4
        with:
          pattern: bottles-*
          path: dist
          merge-multiple: true

      - name: Compute version + root_url
        id: meta
        run: |
          version="$(brew info --json=v2 "${FORMULA}" | python3 -c 'import json, sys; data=json.load(sys.stdin); print(data["formulae"][0]["versions"]["stable"])')"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "root_url=https://github.com/${GITHUB_REPOSITORY}/releases/download/hpc-${version}" >> "$GITHUB_OUTPUT"

      - name: Configure git identity (for brew + commits)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          echo "HOMEBREW_GIT_NAME=github-actions[bot]" >> "$GITHUB_ENV"
          echo "HOMEBREW_GIT_EMAIL=github-actions[bot]@users.noreply.github.com" >> "$GITHUB_ENV"

      - name: Merge bottle metadata into formula (and copy back)
        run: |
          # Merge ALL JSONs into the tapped formula and write bottle stanza
          brew bottle --merge --write --root-url "${{ steps.meta.outputs.root_url }}" dist/*.json

          # Copy the formula from the tap checkout back into this repo workspace
          tap_path="$(brew --repo "${TAP}")"
          src="${tap_path}/Formula/hpc.rb"
          dst="${GITHUB_WORKSPACE}/Formula/hpc.rb"
          python3 - <<'PY'
          import os, shutil
          src = os.environ["src"]
          dst = os.environ["dst"]
          # Make sure the destination dir exists
          os.makedirs(os.path.dirname(dst), exist_ok=True)
          shutil.copyfile(src, dst)
          PY

          # Hard fail if bottle stanza wasn't written
          grep -n "^[[:space:]]*bottle do" "${GITHUB_WORKSPACE}/Formula/hpc.rb"

        env:
          src: ${{ github.workspace }} # placeholder; overridden inside step via shell
          dst: ${{ github.workspace }} # placeholder; overridden inside step via shell

      - name: Commit formula updates (bottle stanza)
        run: |
          git add Formula/hpc.rb
          if ! git diff --cached --quiet; then
            git commit -m "Add bottle for hpc ${{ steps.meta.outputs.version }}"
            git push
          fi

      - name: Create release + upload bottles
        uses: softprops/action-gh-release@v2
        with:
          tag_name: hpc-${{ steps.meta.outputs.version }}
          name: "hpc ${{ steps.meta.outputs.version }} bottles"
          files: dist/*.bottle*.tar.gz
